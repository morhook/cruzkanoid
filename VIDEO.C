#include <dos.h>

#include "cruzkan.h"
#include "video.h" 

unsigned char far *VGA = (unsigned char far *)0xA0000000L;

void set_palette_color(unsigned char index, unsigned char r, unsigned char g, unsigned char b)
{
    outp(0x3C8, index);
    outp(0x3C9, r);
    outp(0x3C9, g);
    outp(0x3C9, b);
}

void set_mode(unsigned char mode)
{
    union REGS regs;
    regs.h.ah = 0x00;
    regs.h.al = mode;
    int86(0x10, &regs, &regs);
}

void put_pixel(int x, int y, unsigned char color)
{
    if (x >= 0 && x < SCREEN_WIDTH && y >= 0 && y < SCREEN_HEIGHT)
    {
        VGA[y * SCREEN_WIDTH + x] = color;
    }
}

void draw_rect(int x, int y, int width, int height, unsigned char color)
{
    int i, j;
    for (i = 0; i < height; i++)
    {
        for (j = 0; j < width; j++)
        {
            put_pixel(x + j, y + i, color);
        }
    }
}

void draw_filled_rect(int x, int y, int width, int height, unsigned char color)
{
    draw_rect(x, y, width, height, color);
}

void clear_screen(unsigned char color)
{
    int i, j;
    for (i = 0; i < SCREEN_WIDTH; i++)
    {
        for (j = 0; j < SCREEN_HEIGHT; j++)
        {
            put_pixel(i, j, color);
        }
    }
}

unsigned char *get_font_char(char c)
{
    static unsigned char font_data[47][7] = {
        /* 0 */ {0x70, 0x88, 0x88, 0x88, 0x88, 0x88, 0x70},
        /* 1 */ {0x20, 0x60, 0x20, 0x20, 0x20, 0x20, 0x70},
        /* 2 */ {0x70, 0x88, 0x08, 0x10, 0x20, 0x40, 0xF8},
        /* 3 */ {0x70, 0x88, 0x08, 0x30, 0x08, 0x88, 0x70},
        /* 4 */ {0x10, 0x30, 0x50, 0x90, 0xF8, 0x10, 0x10},
        /* 5 */ {0xF8, 0x80, 0xF0, 0x08, 0x08, 0x88, 0x70},
        /* 6 */ {0x30, 0x40, 0x80, 0xF0, 0x88, 0x88, 0x70},
        /* 7 */ {0xF8, 0x08, 0x10, 0x20, 0x40, 0x40, 0x40},
        /* 8 */ {0x70, 0x88, 0x88, 0x70, 0x88, 0x88, 0x70},
        /* 9 */ {0x70, 0x88, 0x88, 0x78, 0x08, 0x10, 0x60},
        /* : */ {0x00, 0x20, 0x00, 0x00, 0x00, 0x20, 0x00},
        /* A */ {0x20, 0x50, 0x88, 0x88, 0xF8, 0x88, 0x88},
        /* E */ {0xF8, 0x80, 0x80, 0xF0, 0x80, 0x80, 0xF8},
        /* F */ {0xF8, 0x80, 0x80, 0xF0, 0x80, 0x80, 0x80},
        /* G */ {0x70, 0x88, 0x80, 0xB8, 0x88, 0x88, 0x70},
        /* I */ {0x70, 0x20, 0x20, 0x20, 0x20, 0x20, 0x70},
        /* L */ {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xF8},
        /* M */ {0x88, 0xD8, 0xA8, 0xA8, 0x88, 0x88, 0x88},
        /* N */ {0x88, 0x88, 0xC8, 0xA8, 0x98, 0x88, 0x88},
        /* O */ {0x70, 0x88, 0x88, 0x88, 0x88, 0x88, 0x70},
        /* P */ {0xF0, 0x88, 0x88, 0xF0, 0x80, 0x80, 0x80},
        /* R */ {0xF0, 0x88, 0x88, 0xF0, 0x90, 0x88, 0x88},
        /* S */ {0x70, 0x88, 0x80, 0x70, 0x08, 0x88, 0x70},
        /* U */ {0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x70},
        /* V */ {0x88, 0x88, 0x88, 0x88, 0x50, 0x50, 0x20},
        /* W */ {0x88, 0x88, 0x88, 0xA8, 0xA8, 0xD8, 0x88},
        /* Y */ {0x88, 0x88, 0x50, 0x20, 0x20, 0x20, 0x20},
        /* a */ {0x00, 0x00, 0x70, 0x08, 0x78, 0x88, 0x78},
        /* c */ {0x00, 0x00, 0x70, 0x80, 0x80, 0x88, 0x70},
        /* e */ {0x00, 0x00, 0x70, 0x88, 0xF8, 0x80, 0x70},
        /* i */ {0x20, 0x00, 0x60, 0x20, 0x20, 0x20, 0x70},
        /* k */ {0x80, 0x80, 0x90, 0xA0, 0xE0, 0x90, 0x88},
        /* l */ {0x60, 0x20, 0x20, 0x20, 0x20, 0x20, 0x70},
        /* n */ {0x00, 0x00, 0xB0, 0xC8, 0x88, 0x88, 0x88},
        /* o */ {0x00, 0x00, 0x70, 0x88, 0x88, 0x88, 0x70},
        /* r */ {0x00, 0x00, 0x68, 0x70, 0x40, 0x40, 0x40},
        /* s */ {0x00, 0x00, 0x70, 0x80, 0x70, 0x08, 0xF0},
        /* t */ {0x20, 0x20, 0x70, 0x20, 0x20, 0x20, 0x18},
        /* v */ {0x00, 0x00, 0x88, 0x88, 0x88, 0x50, 0x20},
        /* x */ {0x00, 0x00, 0x88, 0x50, 0x20, 0x50, 0x88},
        /* y */ {0x00, 0x00, 0x88, 0x88, 0x78, 0x08, 0x70},
        /*spc*/ {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        /* C */ {0x70, 0x88, 0x80, 0x80, 0x80, 0x88, 0x70},
        /* D */ {0xF0, 0x88, 0x88, 0x88, 0x88, 0x88, 0xF0},
        /* K */ {0x88, 0x98, 0xA8, 0xC0, 0xA8, 0x98, 0x88},
        /* Z */ {0xF8, 0x08, 0x10, 0x20, 0x40, 0x80, 0xF8},
        /*unk*/ {0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8}};

    if (c >= '0' && c <= '9')
        return font_data[c - '0'];
    if (c == ':')
        return font_data[10];
    if (c == 'A')
        return font_data[11];
    if (c == 'C')
        return font_data[42];
    if (c == 'D')
        return font_data[43];
    if (c == 'E')
        return font_data[12];
    if (c == 'F')
        return font_data[13];
    if (c == 'G')
        return font_data[14];
    if (c == 'I')
        return font_data[15];
    if (c == 'K')
        return font_data[44];
    if (c == 'L')
        return font_data[16];
    if (c == 'M')
        return font_data[17];
    if (c == 'N')
        return font_data[18];
    if (c == 'O')
        return font_data[19];
    if (c == 'P')
        return font_data[20];
    if (c == 'R')
        return font_data[21];
    if (c == 'S')
        return font_data[22];
    if (c == 'U')
        return font_data[23];
    if (c == 'V')
        return font_data[24];
    if (c == 'W')
        return font_data[25];
    if (c == 'Y')
        return font_data[26];
    if (c == 'Z')
        return font_data[45];
    if (c == 'a')
        return font_data[27];
    if (c == 'c')
        return font_data[28];
    if (c == 'e')
        return font_data[29];
    if (c == 'i')
        return font_data[30];
    if (c == 'k')
        return font_data[31];
    if (c == 'l')
        return font_data[32];
    if (c == 'n')
        return font_data[33];
    if (c == 'o')
        return font_data[34];
    if (c == 'r')
        return font_data[35];
    if (c == 's')
        return font_data[36];
    if (c == 't')
        return font_data[37];
    if (c == 'v')
        return font_data[38];
    if (c == 'x')
        return font_data[39];
    if (c == 'y')
        return font_data[40];
    if (c == ' ')
        return font_data[41];
    return font_data[46]; /* unknown char */
}

void draw_char(int x, int y, char c, unsigned char color)
{
    int i, j;
    unsigned char mask;
    unsigned char *font;

    font = get_font_char(c);

    for (i = 0; i < 7; i++)
    {
        mask = font[i];
        for (j = 0; j < 8; j++)
        {
            if (mask & (0x80 >> j))
            {
                put_pixel(x + j, y + i, color);
            }
            else
            {
                put_pixel(x + j, y + i, 0);
            }
        }
    }
}

void draw_text(int x, int y, char *text)
{
    int i = 0;
    while (text[i] != '\0')
    {
        draw_char(x + i * 6, y, text[i], 15);
        i++;
    }
}
